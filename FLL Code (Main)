from pybricks.hubs import PrimeHub
from pybricks.pupdevices import Motor, ColorSensor, UltrasonicSensor, ForceSensor
from pybricks.parameters import Button, Color, Direction, Port, Side, Stop
from pybricks.robotics import DriveBase
from pybricks.tools import wait, StopWatch, multitask, run_task
from umath import sin, cos, tan, pi

tempo = StopWatch()   
hub = PrimeHub()
direito = Motor(Port.F)
esquerdo = Motor(Port.B, Direction.COUNTERCLOCKWISE)
garra_esq = Motor(Port.A, Direction.COUNTERCLOCKWISE)
garra_dir = Motor(Port.E)
sensoresq = ColorSensor(Port.C)
sensordir = ColorSensor(Port.D)
mover = DriveBase(esquerdo, direito, 55, 80)
mover.use_gyro(True)
numero = 1
lancamento = 1
hub.system.set_stop_button(Button.BLUETOOTH)
sensoresq.lights.on(100)
sensordir.lights.on(100)
whiteLow = 95
whiteHigh = 100
blacklow = 10
blackhigh = 20
kD = 0.972
kP = 1.392
erro_ant = 0

def lerE():
    
    return(sensoresq.reflection())

def lerD():

    return(sensordir.reflection())

def andar(distancia, velocidade = 400):
    mover.settings(velocidade, 900, 900, 900)
    mover.straight(distancia*10)

def curva(graus, velocidade = 200):
    mover.settings(50, 600, 130, velocidade)
    mover.turn(graus, Stop.HOLD, True)
    
def garraD(tempo, velocidade=4000, reverse=False):
    velocidadeR = velocidade
    if reverse == True:
        velocidadeR = velocidade * -1
    garra_dir.run_time(velocidadeR, tempo)

def garraE(tempo, velocidade=4000, reverse=False):
    velocidadeR = velocidade
    if reverse == True:
        velocidadeR = velocidade * -1
    garra_esq.run_time(velocidadeR, tempo)

def arco(raio, graus, velocidade = 300):

    mover.settings(velocidade, 400, 400, 400)
    mover.curve(raio, graus)

def ajusteGarra(lado, velocidade=4000, torque=50):

    if lado == "E":

        garra_esq.run_until_stalled(velocidade * -1, Stop.COAST, torque)

    if lado == "D":

        garra_dir.run_until_stalled(velocidade * -1, Stop.COAST, torque)
    
    
def esperar(tempo):
    
    mover.stop()
    wait(tempo*1000)
    mover.stop()

def parar():

    mover.stop()
    wait(1)

def estacionarB(velocidade):

    loop = True

    while loop == True:

        refE = lerE()
        refD = lerD()
        mover.drive(velocidade, 0)

        if refD >= whiteLow and refD <= whiteHigh:

            parar()
            loop = False

        if refE >= whiteLow and refE <= whiteHigh:

            parar()
            loop = False

def estacionarP(velocidade):

    loop = True

    while loop == True:

        refE = lerE()
        refD = lerD()
        mover.drive(velocidade, 0)

        if refD >= blacklow and refD <= blackhigh and refE >= blacklow and refE <= blackhigh:

            mover.stop()
            loop = False

        else:

            wait(1)

def estacionarT(velocidade):

    erro_ant = 0
    taxaCurva = 0

    while True:

        refE = lerE()
        refD = lerD()
        erro = refD - refE
        derivada = erro - (erro_ant * 0.3)
        taxaCurva = (kP * erro) + (kD * derivada)
        erro_ant = erro

        if refE < blackhigh and refE > blacklow and refD < blackhigh and refD > blacklow:

            mover.stop()
            wait(500)
            break

        else:

            mover.drive(velocidade, taxaCurva)
            wait(10)

async def estacionarE(velocidade, torque=50):

    await esquerdo.run_until_stalled(velocidade, Stop.COAST, torque)

async def estacionarD(velocidade, torque=50):

    await direito.run_until_stalled(velocidade, Stop.COAST, torque)

async def est(velocidade, torque=50):

    await multitask(estacionarE(velocidade, torque), estacionarD(velocidade, torque))

def estacionar(velocidade, torque=31):

    run_task(est(velocidade, torque))
    parar()

async def set_timeout(tempo):

    StopWatch.reset()

while numero == 1:

    hub.display.number(lancamento)
    botao = hub.buttons.pressed()
    
    if Button.LEFT in botao: 

        if lancamento == -99:

            lancamento = -99
            hub.display.number(lancamento)

        else:

            lancamento -= 1
            hub.display.number(lancamento)
            wait(250)
    
    if Button.RIGHT in botao:

        if lancamento == 99:

            lancamento = 99

        else:

            lancamento += 1
            hub.display.number(lancamento)
            wait(250)

    if Button.CENTER in botao:
        
        wait(300)

        if lancamento == -1:
            
            ajusteGarra("E")
            garraE(700)
            ajusteGarra("D")
            garraD(747)
            andar(61)
            curva(45)
            andar(-35)
            andar(26.7)
            arco(77.7, -273)
            andar(-35)
            garraD(700)
            curva(-60)
            andar(-4.67)
            curva(60)
            andar(50)
            andar(-15)
            curva(-30)
            andar(30)
            curva(70)
            andar(60)

        if lancamento == 0:
            
            print("Bateria: ", hub.battery.voltage())
            mover.drive(1000, 0)

        if lancamento == 1:
            
            garraD(800)
            andar(57)
            garraD(1000, 4000, True)
            andar(-15)
            curva(-90)
            andar(5.4)
            curva(-83)
            andar(-45)
            garraD(1000)
            andar(23)
            curva(-90)
            andar(12)
            curva(-92)
            andar(5)
            garraE(900, 100000, True)
            andar(-55)
            parar()

        if lancamento == 2:

            andar(62)
            garraE(400, 4000, True)
            curva(-120)
            curva(60)
            curva(-30)
            andar(-10)
            andar(11)
            garraE(800) #Fez a missão 1 
            andar(-10)
            curva(90)
            andar(-9)
            curva(-38)
            garraD(1010, 4000, True)
            andar(25)
            garraD(600, 4000, True)
            curva(-15)
            andar(5)
            curva(15)
            andar(7)
            andar(-5)
            garraD(1000)
            andar(-20)
            curva(40)
            andar(-65)#fez a missão 2
            parar()

        if lancamento == 3:

            ajusteGarra("E", 2500, 40)
            garraE(900)
            andar(86)
            curva(88)
            andar(-4)
            ajusteGarra("E", 3500, 40)
            garraE(455, 3000)
            andar(-2)
            estacionarB(200)
            andar(9)
            garraE(420, 4000)
            garraE(285, 4000, True)
            andar(-20)
            garraE(700)
            curva(-85)
            andar(-85)
            parar()

        if lancamento == 4:
            
            ajusteGarra("E")
            garraE(900)
            andar(57)
            andar(-3)
            garraD(900)
            andar(1)
            curva(90)
            andar(-7)
            curva(-90)
            andar(12)
            garraE(700)
            ajusteGarra("D", 5000, 40)
            garraD(450)
            arco(145, 150)
            curva(-66)
            andar(5)
            curva(-74)
            andar(-2.3)
            garraD(1300, 100000)
            wait(450)
            curva(75)
            andar(20)
            arco(300, 65)
            ajusteGarra("D", -4000, 35)
            curva(-40)
            estacionar(300)
            garraE(950, 4000, True)
            garraE(700)
            andar(-3)
            curva(65)
            andar(21)
            curva(90)
            ajusteGarra("E", 4000, 50)
            garraE(415)
            arco(161, 55.7, 230)
            andar(3.8)
            garraE(600, 100000)
            esperar(0.6)
            arco(-8, -45)
            andar(-19)
            curva(-83)
            andar(-93, 500)
            '''
            arco(-27, 166)
            estacionarT(70)
            curva(-88)
            andar(29)
            curva(-23)
            andar(35)
            curva(27)
            arco(-285, 27)
            curva(-13)
            andar(-5)
            andar(13)
            curva(-20)
            ajusteGarra("D", 4000, 45)
            garraD(650)
            andar(8)
            arco(176, -160)
            curva(10)
            andar(-15)
            '''
            parar()
    
        if lancamento == 5:
            
            andar(47, 450)
            andar(-58, 450)
            parar()
